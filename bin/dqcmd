#!/usr/bin/env bash

usage() {
    echo "$(tput bold)dqcmd$(tput sgr0)

    A Rofi/dmenu interface to qcmd. Excepts all arguments o qcmd (see below).
    "
    qcmd -h | sed "s/qcmd/dqcmd/"
    exit
}

case $1 in
    -h|--help) usage ;;
esac

action=$(qcmd $@)

# Path to menu application
if [[ -n $(command -v rofi) ]]; then
    menu="$(command -v rofi) -dmenu -columns 1"
    global_mesg="Alt-1 	Prompt for args and show function help (if -f is present)..   	Go back to menu.C-u  	Clear inputEsc  	Exit"
    action=$(echo -e "$action" | $menu -mesg "$global_mesg") # For rofi
elif [[ -n $(command -v dmenu) ]]; then
    menu="$(command -v dmenu)"
    action=$(echo -e "$action" | $menu) # For dmenu
else
    echo >&2 "Rofi or dmenu not found"
    exit
fi

action_info=$? # get the return code from rofi

action=$(echo "$action"| cut -f 1 |  sed -e 's/ *$//g')

# if kb-mod-1 key was pressed in rofi
if [ "$action_info" -eq "10" ]; then
    # only run when -f is present (then -i makes sense)
    if [[ $action == *"-f"* ]]; then
        info=$(qcmd $action -i)
        action=$($menu -mesg "$global_mesg<b>Help</b>$info" -filter "$action -a ")
    fi;
fi;

case $action in
    "") ;; # exit
    ..)$0;; # Go back to main menu
    *) $0 "$action" ;;
esac
