import pytest
import xcffib
import xcffib.testing

from libqtile.backend.x11 import window, xcbq


def test_new_window(conn):
    win = conn.create_window(1, 2, 640, 480)
    assert isinstance(win, window.XWindow)
    geom = win.get_geometry()
    assert geom.x == 1
    assert geom.y == 2
    assert geom.width == 640
    assert geom.height == 480
    win.kill_client()
    with pytest.raises(xcffib.ConnectionException):
        win.get_geometry()


def test_masks():
    cfgmasks = xcbq.ConfigureMasks
    d = {"x": 1, "y": 2, "width": 640, "height": 480}
    mask, vals = cfgmasks(**d)
    assert set(vals) == set(d.values())
    with pytest.raises(ValueError):
        mask, vals = cfgmasks(asdf=32, **d)


def test_translate_masks():
    assert xcbq.translate_masks(["shift", "control"])
    assert xcbq.translate_masks([]) == 0


def test_edid_decoding():
    edid = b"\x00\xff\xff\xff\xff\xff\xff\x00L\x83\x9fA\x00\x00\x00\x00\x00!\x01\x04\xb5\x1e\x13x\x02\x0c\xf1\xaeR<\xb9#\x0cPT\x00\x00\x00\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\xca\xfe@d\xb0\x08\x18p \x08\x88\x00.\xbd\x10\x00\x00\x1b\xca\xfe@d\xb0\x088w\x08 \x88\x00.\xbd\x10\x00\x00\x1b\x00\x00\x00\xfe\x00SDC          \x00\x00\x00\xfe\x00ATNA40YK20-0 \x01\xcf\x02\x03\x0f\x00\xe3\x05\x80\x00\xe6\x06\x05\x01t`\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xb7"

    (make, model, serial) = xcbq.parse_edid(edid)
    assert make == "SDC"
    assert model == "SDC"
    assert serial == "ATNA40YK20-0"


def test_edid_decoding_ev2460():
    edid = b"\x00\xff\xff\xff\xff\xff\xff\x00\x15\xc3)1q\xfe[\x011\x1d\x01\x04\xa55\x1ex\xfa\xf9\x95\xa7UT\x9c&\x0fPT\xa1\x08\x00\x81\x80\xb3\x00\xa9\xc0\x81\xc0\x81\x00\x01\x01\x01\x01\x01\x01\x02:\x80\x18q8-@X,E\x00\x10)!\x00\x00\x1e\x00\x00\x00\xff\x0022806129\n    \x00\x00\x00\xfd\x00;=\x1fD\x0f\x01\n      \x00\x00\x00\xfc\x00EV2460\n      \x019\x02\x03\x12\xf1E\x90\x04\x03\x02\x01#\t\x7f\x07\x83\x01\x00\x00\x02:\x80\x18q8-@X,E\x00\x10)!\x00\x00\x1e\x01\x1d\x00rQ\xd0\x1e n(U\x00\x10)!\x00\x00\x1e\x8f\n\xd0\x8a \xe0-\x10\x10>\x96\x00\xdc)\x11\x00\x00\x18\x8c\n\xd0\x8a \xe0-\x10\x10>\x96\x00\x8c)\x11\x00\x00\x18\xd5\t\x80\xa0 \xe0-\x10\x10`\xa2\x00\x8c)\x11\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\n"

    (make, model, serial) = xcbq.parse_edid(edid)
    assert make == "ENC"
    assert model == "EV2460"
    assert serial == "22806129"
